# This software is the exclusive property of Gencovery SAS.
# The use and distribution of this software is prohibited without the prior consent of Gencovery SAS.
# About us: https://gencovery.com

import json

from gws_core import (File, Folder, StrRField, Table, TableImporter,
                      resource_decorator)


@resource_decorator("Qiime2RarefactionAnalysisResultFolder",
                    human_name="Qiime2 rarefaction analysis result folder",
                    short_description="Folder containing the files generated by the Qiime2 rarefaction analysis")
class Qiime2RarefactionAnalysisResultFolder(Folder):
    """
    Qiime2RarefactionAnalysisResultFolder Folder file class
    """

    shannon_index_table_path: str = StrRField()
    observed_features_table_path: str = StrRField()

    def _load_table(self, type_: str) -> Table:
        if type_ == "rarefaction_observed":
            file_path = self.get_sub_path("observed_features.for_boxplot.tsv")
        elif type_ == "rarefaction_shannon":
            file_path = self.get_sub_path("shannon.for_boxplot.tsv")

        table = TableImporter.call(File(path=file_path), {'delimiter': 'tab', "index_column": 0, "header": 0})
        colnames = table.column_names
        column_tags = []
        column_names = []
        for name in colnames:
            name = name.replace("'", '"')
            tag: dict = json.loads(name)
            if "x-axis" in tag:
                tag["depth"] = tag["x-axis"]
                del tag["x-axis"]
            column_tags.append(tag)
            column_names.append(str(tag["depth"]) + "#" + tag["sample-id"])

        data = table.get_data()
        data.columns = column_names

        table = Table(data=data)
        table.set_all_columns_tags(column_tags)  # set_column_tags

        return table
        